<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Evaluación de Empleados</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root{
            --bg:#0B0E14;
            --surface:#0F1115;
            --surface-2:#151924;
            --text:#E7EAF0;
            --text-2:#A7AEC0;
            --primary:#2B6CB0; /* puedes cambiar a #6D28D9 */
            --success:#16A34A;--warning:#F59E0B;--danger:#DC2626;
            --border:#1C1F26;--shadow:0 6px 20px rgba(0,0,0,.35);
            --radius:8px;--space:16px;
            --sidebar-w:280px;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .login-screen {
            padding: 56px 40px;
            text-align: center;
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
        }

        .login-form {
            max-width: 300px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            background: #fff;
            color: #000;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            background-color: var(--primary);
            color: var(--text);
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }

        .btn:hover {
            background-color: #45a049;
        }

        .btn-secondary {
            background-color: #2196F3;
        }

        .btn-secondary:hover {
            background-color: #1976D2;
        }

        .btn-nav {
            background: #FF9800;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-nav:hover {
            background: #F57C00;
        }

        .btn-report {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-report:hover {
            background: #1976D2;
        }

        .header {
            background-color: #8BC34A;
            color: white;
            text-align: center;
            padding: 15px;
            font-weight: bold;
            font-size: 16px;
        }

        .week-header {
            background-color: #A5D6A7;
            color: #2E7D32;
            text-align: center;
            padding: 10px;
            font-weight: bold;
        }

        .evaluation-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .evaluation-table th {
            background-color: #E8F5E8;
            padding: 8px 4px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #ddd;
            font-size: 11px;
        }

        .evaluation-table td {
            padding: 6px 4px;
            border: 1px solid #ddd;
            text-align: center;
            vertical-align: middle;
        }

        .employee-name {
            text-align: left !important;
            font-weight: bold;
            background-color: #f9f9f9;
            padding-left: 10px !important;
            min-width: 200px;
            font-size: 11px;
        }

        .category-header {
            background-color: #C8E6C9;
            font-weight: bold;
            color: #2E7D32;
        }

        .day-header {
            background-color: #FFE082;
            font-weight: bold;
            color: #F57C00;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }

        .evaluation-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .evaluation-checkbox:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
        .item-select {
            padding: 2px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 10px;
            min-width: 90px;
            max-width: 100px;
        }

        .item-select.has-issue {
            background-color: #ffebee;
            border-color: #f44336;
        }

        .week-management {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        .week-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .day-navigation {
            padding: 15px 20px;
            background: #e8f5e8;
            border-bottom: 1px solid #ddd;
            display: none;
        }

        .day-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .day-tab {
            padding: 8px 16px;
            background: #fff;
            border: 2px solid #4CAF50;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .day-tab:hover {
            background: #f0f8f0;
        }

        .day-tab.active {
            background: #4CAF50;
            color: white;
        }

        .reports-module {
            padding: 20px;
            background: #f0f8ff;
            border-bottom: 1px solid #ddd;
            display: none;
        }

        .reports-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .reports-controls input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .navigation-buttons {
            text-align: center;
            padding: 20px;
        }

        .single-day-table {
            display: none;
        }

        .single-day-table.active {
            display: table;
        }

        .hidden {
            display: none;
        }

        /* Module navigation (tabs under header) */
        .module-nav{ display:flex; gap:8px; padding:12px 16px; border-bottom:1px solid #ddd; background:#fff; position:sticky; top:0; z-index:5; }
        .module-nav .module-nav-item{
            background:#f5f7fb; border:1px solid #e2e8f0; color:#334155; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px;
        }
        .module-nav .module-nav-item.active{ background:#e2e8f0; color:#111827; }

        /* Topbar horizontal (reemplaza sidebar) */
        .topbar{ position:sticky; top:0; z-index:10; display:flex; align-items:center; gap:12px; padding:10px 16px; background:#ffffff; border-bottom:1px solid #ddd; }
        .topbar .brand{ display:flex; align-items:center; gap:8px; font-weight:700; color:#111827; }
        .topbar .nav-actions{ display:flex; align-items:center; gap:8px; margin-left:8px; }
        .topbar .nav-btn{ background:#f5f7fb; border:1px solid #e2e8f0; color:#334155; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; }
        .topbar .nav-btn:hover{ background:#e2e8f0; color:#111827; }
        .topbar .search-area{ margin-left:auto; display:flex; align-items:center; gap:10px; }
        .topbar #globalSearch{ padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; min-width:220px; }
        .topbar .manager-name{ color:#475569; font-weight:700; }

        .stats {
            margin-top: 20px;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 4px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .stat-item {
            background: white;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-number {
            font-size: 20px;
            font-weight: bold;
            color: #1976d2;
        }

        @media (max-width: 768px) {
            .evaluation-table {
                font-size: 10px;
            }
            
            .evaluation-table td, .evaluation-table th {
                padding: 4px 2px;
            }
            
            .item-select {
                min-width: 70px;
                font-size: 9px;
            }
        }
        /* Sidebar eliminado: estilos removidos */
    </style>
</head>
<body>
    <div class="container">
        <!-- Pantalla de Login -->
        <div id="loginScreen" class="login-screen">
            <h2>Sistema de Evaluación de Empleados</h2>
            <div class="login-form">
                <div class="form-group">
                    <label for="managerUsername">Usuario:</label>
                    <input type="text" id="managerUsername" placeholder="ej. dmaldonado" />
                </div>
                <div class="form-group">
                    <label for="managerPassword">Contraseña:</label>
                    <input type="password" id="managerPassword" placeholder="Ingrese su contraseña" />
                </div>
                <button class="btn" onclick="login()">Ingresar</button>
            </div>

        </div>

        <!-- Pantalla Principal -->
        <div id="mainScreen" class="hidden">
            <!-- Topbar horizontal -->
            <div class="topbar">
                <div class="brand">
                    <i data-feather="grid"></i>
                    <span>Evaluaciones</span>
                </div>
                <div class="nav-actions">
                    <button class="nav-btn" id="btnCreateWeek" onclick="showCreateWeek()">Crear semana</button>
                    <button class="nav-btn" id="btnWeeklyView" onclick="showWeekView()">Vista semanal</button>
                    <button class="nav-btn" id="btnDailyView" onclick="showDayView()">Vista por día</button>
                    <button class="nav-btn" id="btnReports" onclick="showReports()">Reportes</button>
                    <button class="nav-btn" id="btnMyEvaluations" onclick="showMyEvaluations()" style="display:none;">Mis evaluaciones</button>
                </div>
                <div class="search-area">
                    <input id="globalSearch" type="search" placeholder="Buscar empleado..." oninput="globalSearchChange(this.value)" />
                    <span id="managerHeader" class="manager-name"></span>
                    <button class="nav-btn" id="btnLogout" onclick="logoutApp()">Cerrar sesión</button>
                </div>
            </div>
            
            <!-- Vista: Crear Semana -->
            <div id="createWeekView" class="hidden">
            <!-- Controles de Semana -->
            <div class="week-management">
                <div class="week-controls">
                    <div>
                        <input type="date" id="startDate" placeholder="Fecha Inicio (DD/MM/YYYY)" style="margin-right: 10px; padding: 8px;">
                        <input type="date" id="endDate" placeholder="Fecha Fin (DD/MM/YYYY)" style="margin-right: 10px; padding: 8px;">
                        <button class="btn" onclick="createNewWeek()">Crear Nueva Semana</button>
                        <button class="btn btn-secondary" onclick="loadWeek()">Cargar Semana</button>
                    </div>
                    <div>
                        <select id="weekSelect">
                            <option value="">Seleccionar semana...</option>
                        </select>
                    </div>
                </div>
            </div>
            </div>

            <!-- Navegación entre vistas (antigua) -->
            <div class="navigation-buttons" style="display:none;">
                <button class="btn-nav" onclick="showWeekView()">Vista Semanal</button>
                <button class="btn-nav" onclick="showDayView()">Vista por Día</button>
                <button class="btn-nav" onclick="showReports()">Reportes</button>
            </div>

            <!-- Navegación por días -->
            <div id="dayNavigation" class="day-navigation">
                <div class="day-tabs">
                    <div class="day-tab" onclick="selectDay('LUNES')">LUNES</div>
                    <div class="day-tab" onclick="selectDay('MARTES')">MARTES</div>
                    <div class="day-tab" onclick="selectDay('MIÉRCOLES')">MIÉRCOLES</div>
                    <div class="day-tab" onclick="selectDay('JUEVES')">JUEVES</div>
                    <div class="day-tab" onclick="selectDay('VIERNES')">VIERNES</div>
                </div>
            </div>

            <!-- Módulo de Reportes -->
            <div id="reportsModule" class="reports-module">
                <h3>Módulo de Reportes</h3>
                <div class="reports-controls">
                    <label>Alcance:</label>
                    <select id="reportScope">
                        <option value="current_week">Semana actual</option>
                        <option value="selected_week">Semana específica</option>
                        <option value="all_weeks">Todas las semanas</option>
                    </select>

                    <label id="reportWeekLabel" style="display:none;">Semana:</label>
                    <select id="reportWeek" style="display:none;"></select>

                    <label>Vista:</label>
                    <select id="reportView">
                        <option value="by_employee">Por empleado</option>
                        <option value="by_week">Por semana</option>
                    </select>

                    <label>Categoría:</label>
                    <select id="reportCategory"></select>

                    <label>Empleado (opcional):</label>
                    <select id="reportEmployee">
                        <option value="ALL">Todos</option>
                    </select>

                    <button class="btn-report" onclick="renderReport()">Visualizar</button>
                    <button class="btn-report" onclick="generatePDFReport()">Generar PDF</button>
                    <button class="btn-report" onclick="generateCSVReport()">Generar CSV</button>
                </div>
                <div id="reportsResults" style="margin-top:12px"></div>
            </div>

            <!-- Tabla de Evaluación -->
            <div id="evaluationSection" class="hidden">
                <div id="weekHeader" class="week-header"></div>
                
                <!-- Vista Semanal -->
                <table class="evaluation-table" id="weeklyTable">
                    <thead id="weeklyTableHeader"></thead>
                    <tbody id="evaluationTableBody">
                    </tbody>
                </table>

                <!-- Tablas de Vista por Día -->
                <table class="evaluation-table single-day-table" id="mondayTable">
                    <thead id="mondayTableHeader"></thead>
                    <tbody id="mondayTableBody"></tbody>
                </table>

                <table class="evaluation-table single-day-table" id="tuesdayTable">
                    <thead id="tuesdayTableHeader"></thead>
                    <tbody id="tuesdayTableBody"></tbody>
                </table>

                <table class="evaluation-table single-day-table" id="wednesdayTable">
                    <thead id="wednesdayTableHeader"></thead>
                    <tbody id="wednesdayTableBody"></tbody>
                </table>

                <table class="evaluation-table single-day-table" id="thursdayTable">
                    <thead id="thursdayTableHeader"></thead>
                    <tbody id="thursdayTableBody"></tbody>
                </table>

                <table class="evaluation-table single-day-table" id="fridayTable">
                    <thead id="fridayTableHeader"></thead>
                    <tbody id="fridayTableBody"></tbody>
                </table>

                <div class="stats">
                    <h3>Estadísticas de la Semana</h3>
                    <div class="stats-grid" id="statsGrid">
                    </div>
                </div>
            </div>
            <!-- Mis Evaluaciones (Empleado) - movido al mainScreen -->
            <div id="myEvaluationsSection" class="hidden" style="padding:20px;">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
                    <div id="myWeekHeader" class="week-header" style="margin:0;">Semana:</div>
                    <select id="myWeekSelect" onchange="onMyWeekChange()" style="padding:6px 8px; border-radius:6px; border:1px solid #e5e7eb;"></select>
                </div>
                <table class="evaluation-table" id="myEvaluationsTable">
                    <thead id="myEvaluationsHeader"></thead>
                    <tbody id="myEvaluationsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <script>
        class EmployeeEvaluationSystem {
            constructor() {
                this.currentManager = null;
                this.currentEmployee = null;
                this.employeeManagerId = null;
                this.currentWeek = null;
                this.currentWeekId = null;
                this.evaluationData = {};
                this.weekIdByKey = {};
                this.weekKeyById = {};
                // Datos externos
                this.managers = {};
                this.evaluationItems = {};
                // Mapas de login
                this.managerUsernames = {};
                this.managerPasswords = {};
                this.employeeUsernames = {}; // username -> { managerId, employeeId }
                this.employeePasswords = {}; // employeeId -> password
                // Constantes de UI
                this.categories = ['ASISTENCIA', 'PLÁTICAS', 'PRODUCTIVIDAD', 'ACTITUD'];
                this.categoryMapping = {
                    'ASISTENCIA': 'asistencia',
                    'PLÁTICAS': 'platicas',
                    'PRODUCTIVIDAD': 'productividad',
                    'ACTITUD': 'actitud'
                };
                this.days = ['LUNES', 'MARTES', 'MIÉRCOLES', 'JUEVES', 'VIERNES'];
                // Estado de carga de datos estáticos
                this.dataLoaded = false;
                this.dataLoadPromise = null;
            }
            async loadStaticData() {
                // Carga managers y evaluation items desde /json
                if (this.dataLoadPromise) { await this.dataLoadPromise; return; }
                this.dataLoadPromise = (async () => {
                    const [managersRes, itemsRes] = await Promise.all([
                        fetch('json/managers.json'),
                        fetch('json/evaluation_items.json')
                    ]);
                    this.managers = await managersRes.json();
                    this.evaluationItems = await itemsRes.json();
                })();
                await this.dataLoadPromise;
                // Construir mapas
                this.managerUsernames = {};
                this.managerPasswords = {};
                Object.keys(this.managers).forEach(mid => {
                    const m = this.managers[mid];
                    if (m && m.username) this.managerUsernames[String(m.username).toLowerCase()] = mid;
                    if (m && m.password) this.managerPasswords[mid] = m.password;
                });
                this.employeeUsernames = {};
                this.employeePasswords = {};
                Object.keys(this.managers).forEach(mid => {
                    (this.managers[mid].employees || []).forEach(emp => {
                        if (emp.username) this.employeeUsernames[String(emp.username).toLowerCase()] = { managerId: mid, employeeId: emp.id };
                        if (emp.password) this.employeePasswords[emp.id] = emp.password;
                    });
                });
                this.dataLoaded = true;
            }

            async ensureStaticData(){
                if (!this.dataLoaded) await this.loadStaticData();
            }

            async login() {
                await this.ensureStaticData();
                const username = (document.getElementById('managerUsername').value || '').trim().toLowerCase();
                const password = document.getElementById('managerPassword').value;
                if (!username) {
                    alert('Por favor ingrese el usuario');
                    return;
                }
                if (!password) {
                    alert('Por favor ingrese la contraseña');
                    return;
                }
                // 1) Intento como Manager
                const managerId = this.managerUsernames[username];
                if (managerId) {
                    const expected = this.managerPasswords[managerId];
                    if (typeof expected !== 'string' || password !== expected) {
                        alert('Contraseña incorrecta');
                        return;
                    }
                    this.currentManager = managerId;
                    // Persistir sesión Manager
                    fetch('api/index.php?action=login', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ manager_id: managerId })
                    }).catch(()=>{}).finally(() => {
                        document.getElementById('loginScreen').classList.add('hidden');
                        const main = document.getElementById('mainScreen');
                        main.classList.remove('hidden');
                        if (window.feather && typeof window.feather.replace === 'function') { window.feather.replace(); }
                        document.getElementById('managerHeader').textContent = `MANAGER ${this.managers[managerId].name}`;
                        // Mostrar botones de manager
                        toggleManagerButtons(true);
                        this.loadWeekOptions();
                        this.autoLoadCurrentWeek();
                    });
                    return;
                }
                // 2) Intento como Empleado
                const empInfo = this.employeeUsernames[username];
                if (!empInfo) {
                    alert('Usuario no encontrado');
                    return;
                }
                const empPass = this.employeePasswords[empInfo.employeeId];
                if (typeof empPass !== 'string' || password !== empPass) {
                    alert('Contraseña incorrecta');
                    return;
                }
                // Persistir sesión Empleado
                this.currentEmployee = empInfo.employeeId;
                this.employeeManagerId = empInfo.managerId;
                fetch('api/index.php?action=employee_login', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employee_id: this.currentEmployee, manager_id: this.employeeManagerId })
                }).catch(()=>{}).finally(async () => {
                    document.getElementById('loginScreen').classList.add('hidden');
                    const main = document.getElementById('mainScreen');
                    main.classList.remove('hidden');
                    document.getElementById('managerHeader').textContent = `EMPLEADO ${this.getEmployeeName(this.currentEmployee)}`;
                    await this.loadMyEvaluationsCurrentWeek();
                    await this.loadEmployeeWeeks();
                });
            }

            async loadWeekOptions() {
                const weekSelect = document.getElementById('weekSelect');
                weekSelect.innerHTML = '<option value="">Seleccionar semana...</option>';

                try {
                    const res = await fetch(`api/index.php?action=weeks_list&manager_id=${encodeURIComponent(this.currentManager)}`);
                    const json = await res.json();
                    if (!res.ok) throw new Error(json.error ? JSON.stringify(json.error) : 'Error listando semanas');

                    this.weekIdByKey = {};
                    this.weekKeyById = {};

                    const pad = n => String(n).padStart(2, '0');
                    const parseLocalDate = (yyyy_mm_dd) => {
                        const [y, m, d] = String(yyyy_mm_dd).split('-').map(Number);
                        return new Date(y, (m || 1) - 1, d || 1);
                    };
                    (json.weeks || []).forEach(week => {
                        const start = parseLocalDate(week.start_date);
                        const end = parseLocalDate(week.end_date);
                        const weekKey = `${pad(start.getDate())}/${pad(start.getMonth()+1)}/${start.getFullYear()} - ${pad(end.getDate())}/${pad(end.getMonth()+1)}/${end.getFullYear()}`;
                        console.log(start, end, weekKey);
                        this.weekIdByKey[weekKey] = week.id;
                        this.weekKeyById[week.id] = weekKey;
                        const option = document.createElement('option');
                        option.value = weekKey;
                        option.textContent = weekKey;
                        weekSelect.appendChild(option);
                    });
                } catch (e) {
                    console.error('Error cargando semanas:', e);
                }
            }

            async createNewWeek() {
                const startDateRaw = document.getElementById('startDate').value;
                const endDateRaw = document.getElementById('endDate').value;

                if (!startDateRaw || !endDateRaw) {
                    alert('Por favor ingrese ambas fechas');
                    return;
                }
                // Normalize YYYY-MM-DD (from input[type=date]) to DD/MM/YYYY expected by validator/UI
                const toDMY = (ymd) => {
                    if (/^\d{4}-\d{2}-\d{2}$/.test(ymd)) {
                        const [y, m, d] = ymd.split('-');
                        return `${d}/${m}/${y}`;
                    }
                    return ymd; // already in D/M/Y or other
                };
                const startDateInput = toDMY(startDateRaw);
                const endDateInput = toDMY(endDateRaw);
                console.log('createNewWeek normalized:', startDateRaw, endDateRaw, '->', startDateInput, endDateInput);

                if (!this.validateWeekDates(startDateInput, endDateInput)) {
                    return;
                }

                const weekKey = `${startDateInput} - ${endDateInput}`;
                this.currentWeek = weekKey;

                // Crear semana en servidor
                const toISO = (dmy) => { const [d,m,y] = dmy.split('/'); return `${y}-${m}-${d}`; };
                try {
                    const resp = await fetch('api/index.php?action=weeks_create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            manager_id: this.currentManager,
                            start_date: toISO(startDateInput),
                            end_date: toISO(endDateInput)
                        })
                    });
                    const json = await resp.json();
                    if (!resp.ok) throw new Error(json.error ? JSON.stringify(json.error) : 'Error creando semana');
                    const weekId = json.week.id;
                    this.currentWeekId = weekId;
                    this.weekIdByKey[weekKey] = weekId;
                    this.weekKeyById[weekId] = weekKey;

                    // Inicializa en memoria como antes
                    this.initializeWeekData(weekKey);

                    // Pre-carga evaluaciones en servidor
                    const rows = [];
                    const employees = this.managers[this.currentManager].employees;
                    for (const employee of employees) {
                        for (let i = 0; i < 5; i++) {
                            this.categories.forEach(category => {
                                rows.push({
                                    week_id: weekId,
                                    employee_id: employee.id,
                                    day_index: i,
                                    category: category,
                                    checked: true,
                                    item: 'Sin problemas'
                                });
                            });
                        }
                    }
                    if (rows.length) {
                        const resp2 = await fetch('api/index.php?action=evaluations_bulk_insert', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ rows })
                        });
                        const json2 = await resp2.json();
                        if (!resp2.ok) console.error('Error precargando evaluaciones:', json2.error || json2);
                    }

                    this.renderWeeklyEvaluationTable();
                    this.loadWeekOptions();
                } catch (e) {
                    console.error('Error al crear semana:', e);
                    alert('No se pudo crear la semana en el servidor');
                    return;
                }

                document.getElementById('evaluationSection').classList.remove('hidden');
                document.getElementById('weekHeader').textContent = weekKey;

                // Set week select to current week
                document.getElementById('weekSelect').value = weekKey;
            }

            validateWeekDates(startDateInput, endDateInput) {
                const dateRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
                if (!dateRegex.test(startDateInput) || !dateRegex.test(endDateInput)) {
                    alert('Formato de fecha incorrecto. Use DD/MM/YYYY');
                    return false;
                }
                
                const [startDay, startMonth, startYear] = startDateInput.split('/');
                const [endDay, endMonth, endYear] = endDateInput.split('/');
                
                const startDate = new Date(startYear, startMonth - 1, startDay);
                const endDate = new Date(endYear, endMonth - 1, endDay);
                
                if (startDate.getDay() !== 1) {
                    alert('La fecha de inicio debe ser un LUNES');
                    return false;
                }
                
                if (endDate.getDay() !== 5) {
                    alert('La fecha de fin debe ser un VIERNES');
                    return false;
                }
                
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays !== 4) {
                    alert('Debe haber exactamente 4 días entre lunes y viernes');
                    return false;
                }

                return true;
            }

            initializeWeekData(weekKey) {
                if (!this.evaluationData[this.currentManager]) {
                    this.evaluationData[this.currentManager] = {};
                }

                if (!this.evaluationData[this.currentManager][weekKey]) {
                    this.evaluationData[this.currentManager][weekKey] = {};
                    
                    this.managers[this.currentManager].employees.forEach(employee => {
                        this.evaluationData[this.currentManager][weekKey][employee.id] = [];
                        
                        // Initialize 5 days (Monday to Friday)
                        for (let i = 0; i < 5; i++) {
                            const dayObj = {};
                            this.categories.forEach(cat => {
                                dayObj[cat] = { checked: true, item: 'Sin problemas' };
                            });
                            this.evaluationData[this.currentManager][weekKey][employee.id][i] = dayObj;
                        }
                    });
                }

                this.saveData();
            }

            renderWeeklyEvaluationTable() {
                const tableBody = document.getElementById('evaluationTableBody');
                tableBody.innerHTML = '';

                if (!this.currentWeek || !this.evaluationData[this.currentManager] || !this.evaluationData[this.currentManager][this.currentWeek]) {
                    return;
                }

                const weekData = this.evaluationData[this.currentManager][this.currentWeek];

                // Render header dynamically
                this.renderWeeklyHeader();

                this.managers[this.currentManager].employees.forEach(employee => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="employee-name">${employee.name}</td>`;
                    
                    // Para cada día (5 días)
                    for (let dayIndex = 0; dayIndex < 5; dayIndex++) {
                        const dayData = weekData[employee.id][dayIndex];
                        
                        // Para cada categoría
                        this.categories.forEach(category => {
                            const isChecked = dayData[category].checked ? 'checked' : '';
                            const selectClass = dayData[category].checked ? '' : 'has-issue';
                            const categoryKey = this.categoryMapping[category];

                            row.innerHTML += `
                                <td>
                                    <div class="checkbox-container">
                                        <input type="checkbox" class="evaluation-checkbox" 
                                               ${isChecked} 
                                               disabled>
                                    </div>
                                </td>
                                <td>
                                    <select class="item-select ${selectClass}" 
                                            onchange="evaluationSystem.updateEvaluation('${employee.id}', ${dayIndex}, '${category}', 'item', this.value)">
                                            ${this.evaluationItems[categoryKey].map(item => `
                                                <option value="${item}" ${item === dayData[category].item ? 'selected' : ''}>${item}</option>
                                            `).join('')}
                                    </select>
                                </td>
                            `;
                        });
                    }
                    
                    tableBody.appendChild(row);
                });

                this.updateStats();
            }

            renderWeeklyHeader() {
                const thead = document.getElementById('weeklyTableHeader');
                if (!thead) return;
                let firstRow = '<tr><th rowspan="2">EMPLEADO</th>';
                this.days.forEach(day => {
                    firstRow += `<th colspan="${this.categories.length * 2}" class="day-header">${day}</th>`;
                });
                firstRow += '</tr>';

                let secondRow = '<tr>';
                this.days.forEach(() => {
                    this.categories.forEach(cat => {
                        secondRow += '<th class="category-header">✓</th>';
                        secondRow += `<th class="category-header">${cat}</th>`;
                    });
                });
                secondRow += '</tr>';

                thead.innerHTML = firstRow + secondRow;
            }

            renderSingleDayHeader(day) {
                const headerId = {
                    'LUNES': 'mondayTableHeader',
                    'MARTES': 'tuesdayTableHeader',
                    'MIÉRCOLES': 'wednesdayTableHeader',
                    'JUEVES': 'thursdayTableHeader',
                    'VIERNES': 'fridayTableHeader'
                }[day];
                const thead = document.getElementById(headerId);
                if (!thead) return;
                let html = '<tr>' +
                    '<th rowspan="2">EMPLEADO</th>' +
                    `<th colspan="${this.categories.length * 2}" class="day-header">${day}</th>` +
                    '</tr><tr>';
                this.categories.forEach(cat => {
                    html += '<th class="category-header">✓</th>';
                    html += `<th class="category-header">${cat}</th>`;
                });
                html += '</tr>';
                thead.innerHTML = html;
            }

            renderAllHeaders() {
                this.renderWeeklyHeader();
                this.days.forEach(d => this.renderSingleDayHeader(d));
            }

            async updateEvaluation(employeeId, dayIndex, category, field, value) {
                if (!this.currentWeek || !this.evaluationData[this.currentManager] || !this.evaluationData[this.currentManager][this.currentWeek]) {
                    return;
                }

                const weekData = this.evaluationData[this.currentManager][this.currentWeek];
                
                if (!weekData[employeeId] || !weekData[employeeId][dayIndex]) {
                    return;
                }

                // Obtener la clave correcta para evaluationItems
                const categoryKey = this.categoryMapping[category];
                if (!categoryKey || !this.evaluationItems[categoryKey]) {
                    console.error(`Categoría inválida: ${category}`);
                    return;
                }

                // Actualizar los datos de evaluación
                if (field === 'item') {
                    weekData[employeeId][dayIndex][category]['item'] = value;
                    // Actualizar el estado del checkbox basado en el valor del select
                    weekData[employeeId][dayIndex][category]['checked'] = (value === 'Sin problemas');
                } else if (field === 'checked') {
                    // Si el checkbox es editado (caso hipotético), mantener el valor actual del select
                    weekData[employeeId][dayIndex][category]['checked'] = value;
                    // Asegurar que el checkbox refleje el valor del select
                    if (weekData[employeeId][dayIndex][category]['item'] !== 'Sin problemas' && value) {
                        weekData[employeeId][dayIndex][category]['checked'] = false; // Desmarcar si el item no es 'Sin problemas'
                    } else if (weekData[employeeId][dayIndex][category]['item'] === 'Sin problemas' && !value) {
                        weekData[employeeId][dayIndex][category]['checked'] = true; // Marcar si el item es 'Sin problemas'
                    }
                }
   
                try {
                    const resp = await fetch('api/index.php?action=evaluation_update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            week_id: this.currentWeekId,
                            employee_id: employeeId,
                            day_index: dayIndex,
                            category: category,
                            checked: weekData[employeeId][dayIndex][category].checked,
                            item: weekData[employeeId][dayIndex][category].item
                        })
                    });
                    const json = await resp.json();
                    if (!resp.ok) throw new Error(json.error ? JSON.stringify(json.error) : 'Error actualizando evaluación');
                } catch (e) {
                    console.error('Error actualizando evaluación:', e);
                }

                this.renderWeeklyEvaluationTable();
                
                // Actualizar tablas diarias si está en vista por día
                if (currentView === 'day') {
                    this.renderDayTable(currentDay);
                }
            }

            renderDayTable(day) {
                const dayIndex = this.days.indexOf(day);
                if (dayIndex === -1) return;

                const tableBodyId = {
                    'LUNES': 'mondayTableBody',
                    'MARTES': 'tuesdayTableBody',
                    'MIÉRCOLES': 'wednesdayTableBody',
                    'JUEVES': 'thursdayTableBody',
                    'VIERNES': 'fridayTableBody'
                }[day];
                
                const tbody = document.getElementById(tableBodyId);
                tbody.innerHTML = '';
                
                if (!this.currentWeek || !this.evaluationData[this.currentManager] || !this.evaluationData[this.currentManager][this.currentWeek]) {
                    return;
                }

                const weekData = this.evaluationData[this.currentManager][this.currentWeek];

                this.managers[this.currentManager].employees.forEach(employee => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="employee-name">${employee.name}</td>`;

                    const dayData = weekData[employee.id][dayIndex];

                    this.categories.forEach(category => {
                        const isChecked = dayData[category].checked ? 'checked' : '';
                        const selectClass = dayData[category].checked ? '' : 'has-issue';
                        const categoryKey = this.categoryMapping[category];

                        row.innerHTML += `
                            <td>
                                <div class="checkbox-container">
                                    <input type="checkbox" class="evaluation-checkbox" 
                                           ${isChecked} 
                                           disabled>
                                </div>
                            </td>
                            <td>
                                <select class="item-select ${selectClass}" 
                                        onchange="evaluationSystem.updateEvaluation('${employee.id}', ${dayIndex}, '${category}', 'item', this.value)">
                                        ${this.evaluationItems[categoryKey].map(item => `
                                            <option value="${item}" ${item === dayData[category].item ? 'selected' : ''}>${item}</option>
                                        `).join('')}
                                </select>
                            </td>
                        `;
                    });

                    tbody.appendChild(row);
                });
            }

            updateStats() {
                if (!this.currentWeek || !this.evaluationData[this.currentManager] || !this.evaluationData[this.currentManager][this.currentWeek]) {
                    return;
                }

                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = '';

                const weekData = this.evaluationData[this.currentManager][this.currentWeek];
                const employees = this.managers[this.currentManager].employees;

                // Stats for each day
                for (let dayIndex = 0; dayIndex < 5; dayIndex++) {
                    const dayName = this.days[dayIndex];
                    
                    let totalEmployees = employees.length;
                    let perfectEmployees = 0;
                    const categoryStats = {};
                    this.categories.forEach(c => categoryStats[c] = 0);

                    employees.forEach(employee => {
                        const employeeData = weekData[employee.id][dayIndex];
                        if (employeeData) {
                            let isPerfect = true;
                            this.categories.forEach(category => {
                                if (employeeData[category] && employeeData[category].checked) {
                                    categoryStats[category]++;
                                } else {
                                    isPerfect = false;
                                }
                            });
                            if (isPerfect) perfectEmployees++;
                        }
                    });

                    statsGrid.innerHTML += `
                        <div class="stat-item">
                            <div class="stat-number">${perfectEmployees}/${totalEmployees}</div>
                            <div>Perfectos ${dayName}</div>
                        </div>
                    `;
                }
            }

            async loadWeek() {
                const weekKey = document.getElementById('weekSelect').value;
                if (!weekKey) {
                    alert('Por favor selecciona una semana');
                    return;
                }

                this.currentWeek = weekKey;
                this.currentWeekId = this.weekIdByKey[weekKey] || null;

                if (this.currentWeekId) {
                    try {
                        const res = await fetch(`api/index.php?action=evaluations_by_week&week_id=${encodeURIComponent(this.currentWeekId)}`);
                        const json = await res.json();
                        if (!res.ok) throw new Error(json.error ? JSON.stringify(json.error) : 'Error cargando evaluaciones');

                        if (!this.evaluationData[this.currentManager]) this.evaluationData[this.currentManager] = {};
                        this.evaluationData[this.currentManager][weekKey] = {};

                        // Inicial base
                        this.managers[this.currentManager].employees.forEach(employee => {
                            this.evaluationData[this.currentManager][weekKey][employee.id] = [];
                            for (let i = 0; i < 5; i++) {
                                const dayObj = {};
                                this.categories.forEach(cat => {
                                    dayObj[cat] = { checked: true, item: 'Sin problemas' };
                                });
                                this.evaluationData[this.currentManager][weekKey][employee.id][i] = dayObj;
                            }
                        });

                        (json.evaluations || []).forEach(row => {
                            const emp = row.employee_id;
                            const d = row.day_index;
                            const cat = row.category;
                            if (this.evaluationData[this.currentManager][weekKey][emp] && this.evaluationData[this.currentManager][weekKey][emp][d]) {
                                this.evaluationData[this.currentManager][weekKey][emp][d][cat] = { checked: !!row.checked, item: row.item };
                            }
                        });
                    } catch (e) {
                        console.error('Error cargando evaluaciones:', e);
                    }
                }

                this.renderWeeklyEvaluationTable();
                document.getElementById('evaluationSection').classList.remove('hidden');
                document.getElementById('weekHeader').textContent = weekKey;
                this.renderAllHeaders();
            }

            saveData() {
                // No-op
            }

            loadStoredData() {
                // No-op: persistence handled by backend API now
            }
        }

        // Global variables
        let evaluationSystem;
        let currentView = 'week';
        let currentDay = 'LUNES';

        // Global functions
        function login() {
            evaluationSystem.login();
        }

        function createNewWeek() {
            evaluationSystem.createNewWeek();
        }

        function loadWeek() {
            evaluationSystem.loadWeek();
        }

        // Empleado: cambio de semana en selector
        function onMyWeekChange(){
            const sel = document.getElementById('myWeekSelect');
            if (!sel || !evaluationSystem) return;
            const key = sel.value;
            if (key) evaluationSystem.loadMyEvaluationsByWeekKey(key);
        }

        function setActiveModule(view){
            const btns = document.querySelectorAll('#moduleNav .module-nav-item');
            btns.forEach(b=>b.classList.toggle('active', b.getAttribute('data-view')===view));
        }

        function showCreateWeek(){
            currentView = 'create';
            document.getElementById('createWeekView').classList.remove('hidden');
            document.getElementById('weeklyTable').style.display = 'none';
            document.getElementById('dayNavigation').style.display = 'none';
            document.getElementById('reportsModule').style.display = 'none';
            const dayTables = document.querySelectorAll('.single-day-table');
            dayTables.forEach(table => table.style.display = 'none');
            setActiveModule('create');
        }

        function showWeekView() {
            currentView = 'week';
            document.getElementById('createWeekView').classList.add('hidden');
            document.getElementById('weeklyTable').style.display = 'table';
            document.getElementById('dayNavigation').style.display = 'none';
            document.getElementById('reportsModule').style.display = 'none';
            
            // Hide all day tables
            const dayTables = document.querySelectorAll('.single-day-table');
            dayTables.forEach(table => table.style.display = 'none');
            setActiveModule('week');
        }

        function showDayView() {
            if (!evaluationSystem.currentWeek) {
                alert('Por favor selecciona o crea una semana primero');
                return;
            }
            
            currentView = 'day';
            document.getElementById('createWeekView').classList.add('hidden');
            document.getElementById('weeklyTable').style.display = 'none';
            document.getElementById('dayNavigation').style.display = 'block';
            document.getElementById('reportsModule').style.display = 'none';
            selectDay(currentDay);
            setActiveModule('day');
        }

        async function showReports() {
            currentView = 'reports';
            document.getElementById('createWeekView').classList.add('hidden');
            document.getElementById('weeklyTable').style.display = 'none';
            document.getElementById('dayNavigation').style.display = 'none';
            document.getElementById('reportsModule').style.display = 'block';
            
            // Hide all day tables
            const dayTables = document.querySelectorAll('.single-day-table');
            dayTables.forEach(table => table.style.display = 'none');
            setActiveModule('reports');

            // Llenar empleados en selector de reportes
            const sel = document.getElementById('reportEmployee');
            if (sel && evaluationSystem && evaluationSystem.currentManager) {
                sel.innerHTML = '<option value="ALL">Todos</option>';
                evaluationSystem.managers[evaluationSystem.currentManager].employees.forEach(emp => {
                    const opt = document.createElement('option');
                    opt.value = emp.id;
                    opt.textContent = emp.name;
                    sel.appendChild(opt);
                });
            }

            // Llenar categorías dinámicamente en selector de reportes
            const catSel = document.getElementById('reportCategory');
            if (catSel && evaluationSystem) {
                catSel.innerHTML = '';
                const optAll = document.createElement('option');
                optAll.value = 'ALL';
                optAll.textContent = 'Todas';
                catSel.appendChild(optAll);
                evaluationSystem.categories.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat;
                    opt.textContent = cat;
                    catSel.appendChild(opt);
                });
            }

            // --- Selector de Semana específica ---
            const weekLabel = document.getElementById('reportWeekLabel');
            const weekSelect = document.getElementById('reportWeek');
            const scopeSel = document.getElementById('reportScope');

            const pad = n => String(n).padStart(2, '0');
            const parseLocalDate = (yyyy_mm_dd) => {
                const [y, m, d] = String(yyyy_mm_dd).split('-').map(Number);
                return new Date(y, (m || 1) - 1, (d || 1));
            };

            const populateWeeks = async () => {
                weekSelect.innerHTML = '';
                let keys = [];
                if (evaluationSystem.weekIdByKey && Object.keys(evaluationSystem.weekIdByKey).length) {
                    keys = Object.keys(evaluationSystem.weekIdByKey);
                } else {
                    // Fallback: pedir al backend
                    try {
                        const weeksRes = await fetch(`api/index.php?action=weeks_list&manager_id=${encodeURIComponent(evaluationSystem.currentManager)}`);
                        const weeksJson = await weeksRes.json();
                        const tmpMap = {};
                        (weeksJson.weeks || []).forEach(w => {
                            const s = parseLocalDate(w.start_date), e = parseLocalDate(w.end_date);
                            const key = `${pad(s.getDate())}/${pad(s.getMonth()+1)}/${s.getFullYear()} - ${pad(e.getDate())}/${pad(e.getMonth()+1)}/${e.getFullYear()}`;
                            tmpMap[key] = w.id;
                        });
                        // Guardar en memoria si estructura existe
                        evaluationSystem.weekIdByKey = { ...(evaluationSystem.weekIdByKey || {}), ...tmpMap };
                        keys = Object.keys(tmpMap);
                    } catch (e) {
                        console.warn('No se pudieron cargar semanas para el selector', e);
                    }
                }
                keys.sort();
                keys.forEach(k => {
                    const opt = document.createElement('option');
                    opt.value = k;
                    opt.textContent = k;
                    weekSelect.appendChild(opt);
                });
                if (evaluationSystem.currentWeek && keys.includes(evaluationSystem.currentWeek)) {
                    weekSelect.value = evaluationSystem.currentWeek;
                }
            };

            const toggleWeekSelector = async () => {
                const show = scopeSel.value === 'selected_week';
                weekLabel.style.display = show ? 'inline-block' : 'none';
                weekSelect.style.display = show ? 'inline-block' : 'none';
                if (show) await populateWeeks();
            };

            if (scopeSel && !scopeSel._boundChange) {
                scopeSel.addEventListener('change', toggleWeekSelector);
                scopeSel._boundChange = true;
            }
            await toggleWeekSelector();
        }

        function selectDay(day) {
            currentDay = day;
            
            // Update active tab
            document.querySelectorAll('.day-tab').forEach(tab => tab.classList.remove('active'));
            
            // Find and activate the clicked tab
            const dayTabs = document.querySelectorAll('.day-tab');
            dayTabs.forEach(tab => {
                if (tab.textContent === day) {
                    tab.classList.add('active');
                }
            });
            
            // Hide all day tables
            const dayTables = document.querySelectorAll('.single-day-table');
            dayTables.forEach(table => table.style.display = 'none');
            
            // Show selected day table
            const dayMap = {
                'LUNES': 'mondayTable',
                'MARTES': 'tuesdayTable',
                'MIÉRCOLES': 'wednesdayTable',
                'JUEVES': 'thursdayTable',
                'VIERNES': 'fridayTable'
            };
            
            document.getElementById(dayMap[day]).style.display = 'table';
            
            // Render the day table
            evaluationSystem.renderSingleDayHeader(day);
            evaluationSystem.renderDayTable(day);
        }

        function generatePDFReport() {
            const resultsDiv = document.getElementById('reportsResults');
            const table = resultsDiv ? resultsDiv.querySelector('table') : null;
            if (!table) {
                alert('Primero visualiza un reporte (clic en "Visualizar").');
                return;
            }
            const scope = document.getElementById('reportScope')?.value || 'current_week';
            const view = document.getElementById('reportView')?.value || 'by_employee';
            const category = document.getElementById('reportCategory')?.value || 'ALL';
            const employeeId = document.getElementById('reportEmployee')?.value || 'ALL';
            const managerName = evaluationSystem.managers[evaluationSystem.currentManager]?.name || '';

            const headerInfo = `Alcance: ${scope} | Vista: ${view} | Categoría: ${category} | Empleado: ${employeeId}`;

            const html = `<!doctype html>
            <html><head><meta charset="utf-8" />
            <title>Reporte</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { margin: 0 0 6px 0; }
                .meta { color: #555; margin-bottom: 12px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
                th { background: #4CAF50; color: #fff; }
                .employee-name { text-align: left; }
            </style></head>
            <body>
                <h1>Reporte de Evaluaciones</h1>
                <div class="meta">Manager: ${managerName}</div>
                <div class="meta">${headerInfo}</div>
                ${table.outerHTML}
            </body></html>`;

            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
            win.focus();
            win.print();
        }

        function generateCSVReport() {
            const resultsDiv = document.getElementById('reportsResults');
            const table = resultsDiv ? resultsDiv.querySelector('table') : null;
            if (!table) {
                alert('Primero visualiza un reporte (clic en "Visualizar").');
                return;
            }
            let csv = '';
            const rows = table.querySelectorAll('tr');
            rows.forEach((tr, idx) => {
                const cells = tr.querySelectorAll(idx === 0 ? 'th' : 'td');
                const values = Array.from(cells).map(td => '"' + td.textContent.replace(/"/g, '""') + '"');
                csv += values.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
            link.download = `reporte_${ts}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Visualiza porcentajes en el módulo de Reportes
        async function renderReport() {
            const scope = document.getElementById('reportScope')?.value || 'current_week';
            const view = document.getElementById('reportView')?.value || 'by_employee';
            const category = document.getElementById('reportCategory')?.value || 'ALL';
            const employeeId = document.getElementById('reportEmployee')?.value || 'ALL';
            const selectedWeekKey = document.getElementById('reportWeek')?.value || '';

            const resultsDiv = document.getElementById('reportsResults');
            if (!resultsDiv) return;
            resultsDiv.innerHTML = 'Cargando...';

            // Dataset: { weekKey: { empId: [day0..day4] } }
            let dataset = {};
            try {
                if (scope === 'current_week') {
                    if (!evaluationSystem.currentWeek) {
                        resultsDiv.innerHTML = 'Selecciona o crea una semana primero';
                        return;
                    }
                    const wk = evaluationSystem.currentWeek;
                    dataset[wk] = evaluationSystem.evaluationData[evaluationSystem.currentManager][wk];
                } else if (scope === 'selected_week') {
                    const wk = selectedWeekKey || evaluationSystem.currentWeek;
                    if (!wk) {
                        resultsDiv.innerHTML = 'Selecciona una semana específica';
                        return;
                    }
                    // Si es la semana actual y tenemos datos en memoria, úsala
                    if (wk === evaluationSystem.currentWeek && evaluationSystem.evaluationData[evaluationSystem.currentManager][wk]) {
                        dataset[wk] = evaluationSystem.evaluationData[evaluationSystem.currentManager][wk];
                    } else {
                        // Obtener ID de la semana y traer evaluaciones del backend
                        if (!evaluationSystem.weekIdByKey[wk]) {
                            await evaluationSystem.loadWeekOptions();
                        }
                        const weekId = evaluationSystem.weekIdByKey[wk];
                        if (!weekId) {
                            resultsDiv.innerHTML = 'No se encontró la semana seleccionada';
                            return;
                        }
                        // Inicializar estructura base para esa semana
                        dataset[wk] = {};
                        evaluationSystem.managers[evaluationSystem.currentManager].employees.forEach(emp => {
                            dataset[wk][emp.id] = [];
                            for (let i = 0; i < 5; i++) {
                                const dayObj = {};
                                evaluationSystem.categories.forEach(cat => { dayObj[cat] = { checked: true, item: 'Sin problemas' }; });
                                dataset[wk][emp.id][i] = dayObj;
                            }
                        });
                        // Rellenar con datos reales
                        const res = await fetch(`api/index.php?action=evaluations_by_week&week_id=${encodeURIComponent(weekId)}`);
                        const json = await res.json();
                        if (res.ok) {
                            (json.evaluations || []).forEach(row => {
                                const emp = row.employee_id, d = row.day_index, cat = row.category;
                                if (dataset[wk][emp] && dataset[wk][emp][d]) {
                                    dataset[wk][emp][d][cat] = { checked: !!row.checked, item: row.item };
                                }
                            });
                        }
                    }
                } else {
                    // Traer todas las semanas y evaluaciones
                    const weeksRes = await fetch(`api/index.php?action=weeks_list&manager_id=${encodeURIComponent(evaluationSystem.currentManager)}`);
                    const weeksJson = await weeksRes.json();
                    if (!weeksRes.ok) throw new Error(JSON.stringify(weeksJson.error || weeksJson));
                    const pad = n => String(n).padStart(2, '0');
                    const parseLocalDate = (yyyy_mm_dd) => {
                        const [y, m, d] = String(yyyy_mm_dd).split('-').map(Number);
                        return new Date(y, (m || 1) - 1, d || 1);
                    };
                    const idToKey = {};
                    (weeksJson.weeks || []).forEach(w => {
                        const s = parseLocalDate(w.start_date), e = parseLocalDate(w.end_date);
                        idToKey[w.id] = `${pad(s.getDate())}/${pad(s.getMonth()+1)}/${s.getFullYear()} - ${pad(e.getDate())}/${pad(e.getMonth()+1)}/${e.getFullYear()}`;
                        dataset[idToKey[w.id]] = {};
                        evaluationSystem.managers[evaluationSystem.currentManager].employees.forEach(emp => {
                            dataset[idToKey[w.id]][emp.id] = [];
                            for (let i = 0; i < 5; i++) {
                                const dayObj = {};
                                evaluationSystem.categories.forEach(cat => {
                                    dayObj[cat] = { checked: true, item: 'Sin problemas' };
                                });
                                dataset[idToKey[w.id]][emp.id][i] = dayObj;
                            }
                        });
                    });
                    for (const week of (weeksJson.weeks || [])) {
                        const res = await fetch(`api/index.php?action=evaluations_by_week&week_id=${encodeURIComponent(week.id)}`);
                        const json = await res.json();
                        if (!res.ok) continue;
                        const key = idToKey[week.id];
                        (json.evaluations || []).forEach(row => {
                            const emp = row.employee_id, d = row.day_index, cat = row.category;
                            if (dataset[key][emp] && dataset[key][emp][d]) {
                                dataset[key][emp][d][cat] = { checked: !!row.checked, item: row.item };
                            }
                        });
                    }
                }
            } catch (e) {
                console.error(e);
                resultsDiv.innerHTML = 'Error cargando datos de reportes';
                return;
            }

            const mgr = evaluationSystem.managers[evaluationSystem.currentManager];
            const selectedEmployees = (employeeId === 'ALL') ? mgr.employees.map(e => e.id) : [employeeId];
            const categories = (category === 'ALL') ? evaluationSystem.categories : [category];

            if (view === 'by_employee') {
                const cols = [...categories, 'TOTAL'];
                const table = document.createElement('table');
                table.className = 'evaluation-table';
                let html = '<thead><tr><th>Empleado</th>' + cols.map(c=>`<th>${c} (%)</th>`).join('') + '</tr></thead><tbody>';
                selectedEmployees.forEach(empId => {
                    let okTot=0, totTot=0; const perCat={}; categories.forEach(c=>perCat[c]={ok:0,tot:0});
                    Object.keys(dataset).forEach(weekKey => {
                        const wk = dataset[weekKey]; if (!wk[empId]) return;
                        for (let d=0; d<5; d++) { categories.forEach(c=>{ const cell = wk[empId][d][c]; if (!cell) return; perCat[c].tot++; perCat[c].ok+=cell.checked?1:0; totTot++; okTot+=cell.checked?1:0; }); }
                    });
                    const rowVals = categories.map(c => perCat[c].tot ? Math.round(perCat[c].ok*100/perCat[c].tot) : 0);
                    const totalPct = totTot ? Math.round(okTot*100/totTot) : 0;
                    const name = (mgr.employees.find(e=>e.id===empId)||{}).name || empId;
                    html += `<tr><td class="employee-name">${name}</td>` + rowVals.map(v=>`<td>${v}%</td>`).join('') + `<td>${totalPct}%</td></tr>`;
                });
                html += '</tbody>';
                table.innerHTML = html;
                resultsDiv.innerHTML = '';
                resultsDiv.appendChild(table);
            } else {
                // by_week
                const cols = [...categories, 'TOTAL'];
                const table = document.createElement('table');
                table.className = 'evaluation-table';
                let html = '<thead><tr><th>Semana</th>' + cols.map(c=>`<th>${c} (%)</th>`).join('') + '</tr></thead><tbody>';
                Object.keys(dataset).sort().forEach(weekKey => {
                    let okTot=0, totTot=0; const perCat={}; categories.forEach(c=>perCat[c]={ok:0,tot:0});
                    const emps = (employeeId==='ALL')? mgr.employees.map(e=>e.id):[employeeId];
                    emps.forEach(empId => { if (!dataset[weekKey][empId]) return; for (let d=0; d<5; d++) { categories.forEach(c=>{ const cell = dataset[weekKey][empId][d][c]; if (!cell) return; perCat[c].tot++; perCat[c].ok+=cell.checked?1:0; totTot++; okTot+=cell.checked?1:0; }); } });
                    const rowVals = categories.map(c => perCat[c].tot ? Math.round(perCat[c].ok*100/perCat[c].tot) : 0);
                    const totalPct = totTot ? Math.round(okTot*100/totTot) : 0;
                    html += `<tr><td>${weekKey}</td>` + rowVals.map(v=>`<td>${v}%</td>`).join('') + `<td>${totalPct}%</td></tr>`;
                });
                html += '</tbody>';
                table.innerHTML = html;
                resultsDiv.innerHTML = '';
                resultsDiv.appendChild(table);
            }
        }

        function generateReportTable(weekData) {
            let tableHTML = '<table><thead><tr><th>Empleado</th><th>Día</th><th>Categoría</th><th>Estado</th><th>Item</th></tr></thead><tbody>';
            
            Object.keys(weekData).forEach(employeeId => {
                const employee = evaluationSystem.managers[evaluationSystem.currentManager].employees.find(emp => emp.id === employeeId);
                if (!employee) return;
                
                weekData[employeeId].forEach((dayData, dayIndex) => {
                    const dayName = evaluationSystem.days[dayIndex];
                    
                    evaluationSystem.categories.forEach(category => {
                        if (dayData[category]) {
                            tableHTML += `<tr>
                                <td>${employee.name}</td>
                                <td>${dayName}</td>
                                <td>${category}</td>
                                <td>${dayData[category].checked ? 'Aprobado' : 'No Aprobado'}</td>
                                <td>${dayData[category].item}</td>
                            </tr>`;
                        }
                    });
                });
            });
            
            tableHTML += '</tbody></table>';
            return tableHTML;
        }

        // ==== Empleado: Mis Evaluaciones ====
        function toggleManagerButtons(isManager){
            const ids = ['btnCreateWeek','btnWeeklyView','btnDailyView','btnReports'];
            ids.forEach(id=>{ const el=document.getElementById(id); if (el) el.style.display = isManager ? '' : 'none'; });
            const myBtn = document.getElementById('btnMyEvaluations');
            if (myBtn) myBtn.style.display = isManager ? 'none' : '';
            // Hide/Show search only for manager context
            const search = document.getElementById('globalSearch'); if (search) search.style.display = isManager ? '' : 'none';
        }

        function showMyEvaluations(){
            // Hide manager sections
            document.getElementById('createWeekView')?.classList.add('hidden');
            document.getElementById('evaluationSection')?.classList.add('hidden');
            document.getElementById('reportsModule')?.classList.add('hidden');
            document.getElementById('dayNavigation')?.style.setProperty('display','none');
            // Show employee section
            document.getElementById('myEvaluationsSection')?.classList.remove('hidden');
        }

        EmployeeEvaluationSystem.prototype.getEmployeeName = function(empId){
            for (const mid of Object.keys(this.managers)){
                const emp = (this.managers[mid].employees||[]).find(e=>e.id===empId);
                if (emp) return emp.name;
            }
            return empId;
        }

        EmployeeEvaluationSystem.prototype.loadMyEvaluationsCurrentWeek = async function(){
            try{
                // Obtener semana actual o última del manager del empleado
                const res = await fetch(`api/index.php?action=weeks_current&manager_id=${encodeURIComponent(this.employeeManagerId)}`);
                const json = await res.json();
                const w = json.week;
                if (!w){
                    document.getElementById('myWeekHeader').textContent = 'No hay semanas disponibles';
                    showMyEvaluations();
                    return;
                }
                // Construir weekKey
                const pad = n => String(n).padStart(2,'0');
                const parseLocalDate = (yyyy_mm_dd) => { const [y,m,d] = String(yyyy_mm_dd).split('-').map(Number); return new Date(y, (m||1)-1, d||1); };
                const s = parseLocalDate(w.start_date), e = parseLocalDate(w.end_date);
                const weekKey = `${pad(s.getDate())}/${pad(s.getMonth()+1)}/${s.getFullYear()} - ${pad(e.getDate())}/${pad(e.getMonth()+1)}/${e.getFullYear()}`;
                this.currentWeek = weekKey;
                this.currentWeekId = w.id;
                document.getElementById('myWeekHeader').textContent = `Semana: ${weekKey}`;

                // Traer evaluaciones solo del empleado
                const evRes = await fetch(`api/index.php?action=evaluations_by_week_employee&week_id=${encodeURIComponent(w.id)}&employee_id=${encodeURIComponent(this.currentEmployee)}`);
                const evJson = await evRes.json();
                const rows = (evJson.evaluations||[]);
                this.renderMyEvaluationsTable(rows);
                showMyEvaluations();
            }catch(e){
                console.error('loadMyEvaluationsCurrentWeek error', e);
            }
        }

        // Cargar lista de semanas del manager del empleado y llenar el selector
        EmployeeEvaluationSystem.prototype.loadEmployeeWeeks = async function(){
            try{
                const sel = document.getElementById('myWeekSelect');
                if (!sel) return;
                sel.innerHTML = '';
                const res = await fetch(`api/index.php?action=weeks_list&manager_id=${encodeURIComponent(this.employeeManagerId)}`);
                if (!res.ok) return;
                const js = await res.json();
                const weeks = js.weeks || [];
                const pad = n => String(n).padStart(2,'0');
                const parseLocalDate = (yyyy_mm_dd) => { const [y,m,d] = String(yyyy_mm_dd).split('-').map(Number); return new Date(y, (m||1)-1, d||1); };
                // Limpiar mapas previos
                this.weekIdByKey = {};
                this.weekKeyById = {};
                weeks.forEach(w => {
                    const s = parseLocalDate(w.start_date), e = parseLocalDate(w.end_date);
                    const key = `${pad(s.getDate())}/${pad(s.getMonth()+1)}/${s.getFullYear()} - ${pad(e.getDate())}/${pad(e.getMonth()+1)}/${e.getFullYear()}`;
                    this.weekIdByKey[key] = w.id;
                    this.weekKeyById[w.id] = key;
                });
                // Ordenar por fecha de inicio descendente ya viene del backend, pero aseguramos usando la lista
                weeks.forEach(w => {
                    const key = this.weekKeyById[w.id];
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = key;
                    sel.appendChild(opt);
                });
                // Seleccionar la semana actual si está definida
                if (this.currentWeek && this.weekIdByKey[this.currentWeek]){
                    sel.value = this.currentWeek;
                } else if (sel.options.length > 0) {
                    sel.selectedIndex = 0;
                }
            }catch(e){
                console.error('loadEmployeeWeeks error', e);
            }
        }

        // Cargar evaluaciones del empleado por weekKey seleccionada
        EmployeeEvaluationSystem.prototype.loadMyEvaluationsByWeekKey = async function(weekKey){
            try{
                const weekId = this.weekIdByKey[weekKey];
                if (!weekId) return;
                this.currentWeek = weekKey;
                this.currentWeekId = weekId;
                document.getElementById('myWeekHeader').textContent = `Semana: ${weekKey}`;
                const evRes = await fetch(`api/index.php?action=evaluations_by_week_employee&week_id=${encodeURIComponent(weekId)}&employee_id=${encodeURIComponent(this.currentEmployee)}`);
                const evJson = await evRes.json();
                const rows = (evJson.evaluations||[]);
                this.renderMyEvaluationsTable(rows);
            }catch(e){
                console.error('loadMyEvaluationsByWeekKey error', e);
            }
        }

        EmployeeEvaluationSystem.prototype.renderMyEvaluationsTable = function(rows){
            const head = document.getElementById('myEvaluationsHeader');
            const body = document.getElementById('myEvaluationsBody');
            if (!head || !body) return;
            const days = ['LUNES','MARTES','MIÉRCOLES','JUEVES','VIERNES'];
            const cats = this.categories;
            head.innerHTML = '';
            body.innerHTML = '';
            // Header
            const trH = document.createElement('tr');
            trH.innerHTML = `<th class="category-header">Categoría</th>${days.map(d=>`<th class="day-header">${d}</th>`).join('')}`;
            head.appendChild(trH);
            // Build data map: [day_index][category] -> {item,checked}
            const map = {};
            rows.forEach(r=>{
                if (!map[r.day_index]) map[r.day_index] = {};
                map[r.day_index][r.category] = { item: r.item, checked: !!r.checked };
            });
            // Rows per category
            cats.forEach(cat => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="employee-name">${cat}</td>` + days.map((_,idx)=>{
                    const d = map[idx]?.[cat];
                    const item = d ? d.item : 'Sin datos';
                    const ok = d ? d.checked : true;
                    const badge = ok ? '<span style="color:#2e7d32;">✔</span>' : '<span style="color:#dc2626;">✖</span>';
                    return `<td>${badge} <small>${item}</small></td>`;
                }).join('');
                body.appendChild(tr);
            });
        }

        // Helpers para inicializar desde sesión activa
        async function checkSessionAndInit(){
            try{
                evaluationSystem = new EmployeeEvaluationSystem();
                // Cargar datos estáticos desde /json antes de cualquier acción
                await evaluationSystem.loadStaticData();
                // 1) Intentar restaurar sesión de manager
                const r = await fetch('api/index.php?action=session_status');
                const js = await r.json();
                if (js.logged_in && js.manager_id){
                    evaluationSystem.currentManager = js.manager_id;
                    document.getElementById('loginScreen').classList.add('hidden');
                    const main = document.getElementById('mainScreen');
                    main.classList.remove('hidden');
                    if (window.feather && typeof window.feather.replace === 'function') { window.feather.replace(); }
                    const name = evaluationSystem.managers[js.manager_id]?.name || js.manager_id;
                    document.getElementById('managerHeader').textContent = `MANAGER ${name}`;
                    toggleManagerButtons(true);
                    await evaluationSystem.loadWeekOptions();
                    await evaluationSystem.autoLoadCurrentWeek();
                    return;
                }
                // 2) Intentar restaurar sesión de empleado
                const r2 = await fetch('api/index.php?action=employee_session_status');
                const js2 = await r2.json();
                if (js2.logged_in && js2.employee_id){
                    evaluationSystem.currentEmployee = js2.employee_id;
                    evaluationSystem.employeeManagerId = js2.manager_id;
                    document.getElementById('loginScreen').classList.add('hidden');
                    const main = document.getElementById('mainScreen');
                    main.classList.remove('hidden');
                    if (window.feather && typeof window.feather.replace === 'function') { window.feather.replace(); }
                    toggleManagerButtons(false);
                    document.getElementById('btnMyEvaluations').style.display = '';
                    const empName = evaluationSystem.getEmployeeName(js2.employee_id);
                    document.getElementById('managerHeader').textContent = `EMPLEADO ${empName}`;
                    await evaluationSystem.loadMyEvaluationsCurrentWeek();
                    await evaluationSystem.loadEmployeeWeeks();
                    return;
                }
                // mostrar login si no hay ninguna sesión
                document.getElementById('loginScreen').classList.remove('hidden');
            }catch(e){
                console.error(e);
                evaluationSystem = new EmployeeEvaluationSystem();
            }
        }

        // Cerrar sesión (manager o empleado)
        async function logoutApp(){
            try{
                if (evaluationSystem && evaluationSystem.currentManager){
                    await fetch('api/index.php?action=logout', { method:'POST' });
                } else if (evaluationSystem && evaluationSystem.currentEmployee){
                    await fetch('api/index.php?action=employee_logout', { method:'POST' });
                }
            } catch(e) {
                console.error('logout error', e);
            }
            // Reset UI/state
            try { evaluationSystem = new EmployeeEvaluationSystem(); } catch (_) {}
            const main = document.getElementById('mainScreen');
            const login = document.getElementById('loginScreen');
            if (main) main.classList.add('hidden');
            if (login) login.classList.remove('hidden');
        }

        // Auto-carga de semana actual o última
        EmployeeEvaluationSystem.prototype.autoLoadCurrentWeek = async function(){
            try{
                const res = await fetch(`api/index.php?action=weeks_current&manager_id=${encodeURIComponent(this.currentManager)}`);
                const json = await res.json();
                const w = json.week;
                if (!w){
                    // No hay semanas: mostrar vista para crear
                    showCreateWeek?.();
                    return;
                }
                // Mapear weekId <-> weekKey
                const pad = n => String(n).padStart(2,'0');
                const parseLocalDate = (yyyy_mm_dd) => { const [y,m,d] = String(yyyy_mm_dd).split('-').map(Number); return new Date(y, (m||1)-1, d||1); };
                const s = parseLocalDate(w.start_date), e = parseLocalDate(w.end_date);
                const weekKey = `${pad(s.getDate())}/${pad(s.getMonth()+1)}/${s.getFullYear()} - ${pad(e.getDate())}/${pad(e.getMonth()+1)}/${e.getFullYear()}`;
                this.currentWeek = weekKey;
                this.currentWeekId = w.id;
                this.weekIdByKey[weekKey] = w.id;
                this.weekKeyById[w.id] = weekKey;
                // Inicializar estructura en memoria si no existe
                if (!this.evaluationData[this.currentManager] || !this.evaluationData[this.currentManager][weekKey]){
                    this.initializeWeekData(weekKey);
                }
                // Hidratar datos desde backend
                const evRes = await fetch(`api/index.php?action=evaluations_by_week&week_id=${encodeURIComponent(w.id)}`);
                const evJson = await evRes.json();
                if (evRes.ok){
                    const mgrEmps = this.managers[this.currentManager].employees;
                    // Reset default
                    mgrEmps.forEach(emp=>{
                        for (let i=0;i<5;i++){
                            const dayObj = {};
                            this.categories.forEach(cat => { dayObj[cat] = { checked: true, item: 'Sin problemas' }; });
                            this.evaluationData[this.currentManager][weekKey][emp.id][i] = dayObj;
                        }
                    });
                    (evJson.evaluations||[]).forEach(row => {
                        const d = row.day_index, emp=row.employee_id, cat=row.category;
                        if (this.evaluationData[this.currentManager][weekKey][emp] && this.evaluationData[this.currentManager][weekKey][emp][d]){
                            this.evaluationData[this.currentManager][weekKey][emp][d][cat] = { checked: !!row.checked, item: row.item };
                        }
                    });
                }
                // Mostrar vista semanal por defecto
                document.getElementById('evaluationSection').classList.remove('hidden');
                document.getElementById('weekHeader').textContent = weekKey;
                this.renderWeeklyEvaluationTable?.();
                showWeekView?.();
                // Seleccionar en el select
                const wkSel = document.getElementById('weekSelect'); if (wkSel) wkSel.value = weekKey;
            }catch(e){
                console.error('autoLoadCurrentWeek error', e);
            }
        }

        // Initialize system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            checkSessionAndInit();
        });
    </script>
</body>
</html>